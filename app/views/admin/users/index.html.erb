<% content_for :title, "사용자 관리 - YouTube 트렌드 관리자" %>

<div class="container-fluid py-4">
  <!-- 헤더 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 mb-1">
            <i class="fas fa-users text-primary me-2"></i>
            사용자 관리
          </h1>
          <p class="text-muted mb-0">시스템 사용자 조회 및 권한 관리</p>
        </div>
        <div>
          <%= link_to new_admin_user_path, class: "btn btn-success me-2" do %>
            <i class="fas fa-plus me-1"></i> 새 사용자 추가
          <% end %>
          <%= link_to admin_root_path, class: "btn btn-outline-secondary" do %>
            <i class="fas fa-arrow-left me-1"></i> 대시보드로
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- 통계 카드 -->
  <div class="row g-3 mb-4">
    <div class="col-xl-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-1 text-primary fw-bold"><%= @stats[:total] %></h4>
              <p class="text-muted mb-0 small">총 사용자</p>
            </div>
            <div class="col-auto">
              <i class="fas fa-users fa-lg text-primary opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-1 text-danger fw-bold"><%= @stats[:admins] %></h4>
              <p class="text-muted mb-0 small">관리자</p>
            </div>
            <div class="col-auto">
              <i class="fas fa-crown fa-lg text-danger opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-1 text-success fw-bold"><%= @stats[:active] %></h4>
              <p class="text-muted mb-0 small">활성 계정</p>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-lg text-success opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-1 text-warning fw-bold"><%= @stats[:inactive] %></h4>
              <p class="text-muted mb-0 small">비활성</p>
            </div>
            <div class="col-auto">
              <i class="fas fa-pause-circle fa-lg text-warning opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-1 text-danger fw-bold"><%= @stats[:suspended] %></h4>
              <p class="text-muted mb-0 small">정지</p>
            </div>
            <div class="col-auto">
              <i class="fas fa-ban fa-lg text-danger opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="mb-1 text-info fw-bold"><%= @stats[:recent_login] %></h4>
              <p class="text-muted mb-0 small">최근 활동</p>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-lg text-info opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 검색 및 필터 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <%= form_with url: admin_users_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
            <div class="col-md-4">
              <%= form.label :search, "검색", class: "form-label fw-bold" %>
              <%= form.text_field :search, 
                    value: params[:search], 
                    placeholder: "이름 또는 이메일로 검색...", 
                    class: "form-control" %>
            </div>
            
            <div class="col-md-3">
              <%= form.label :filter, "필터", class: "form-label fw-bold" %>
              <%= form.select :filter, 
                    options_for_select([
                      ['전체', ''],
                      ['관리자', 'admins'],
                      ['일반사용자', 'regular_users'],
                      ['활성 계정', 'active'],
                      ['비활성 계정', 'inactive'],
                      ['정지된 계정', 'suspended'],
                      ['최근 활동', 'recent_login']
                    ], params[:filter]), 
                    {}, 
                    { class: "form-select" } %>
            </div>
            
            <div class="col-md-2">
              <%= form.submit "검색", class: "btn btn-primary w-100" %>
            </div>
            
            <div class="col-md-2">
              <%= link_to admin_users_path, class: "btn btn-outline-secondary w-100" do %>
                <i class="fas fa-times me-1"></i> 초기화
              <% end %>
            </div>
            
            <div class="col-md-1">
              <button type="button" class="btn btn-outline-info w-100" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- 사용자 목록 테이블 -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-list me-2"></i>
            사용자 목록 
            <span class="badge bg-primary ms-2"><%= @users.respond_to?(:total_count) ? @users.total_count : @users.count %></span>
          </h6>
          <div>
            <small class="text-muted">총 <%= @stats[:total] %>명 중 <%= @users.count %>명 표시</small>
          </div>
        </div>
        
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>사용자</th>
                  <th>이메일</th>
                  <th>권한</th>
                  <th>상태</th>
                  <th>가입일</th>
                  <th>최근 로그인</th>
                  <th>액션</th>
                </tr>
              </thead>
              <tbody>
                <% @users.each do |user| %>
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="avatar avatar-sm rounded-circle bg-primary text-white me-3 d-flex align-items-center justify-content-center">
                          <%= user.name.first.upcase %>
                        </div>
                        <div>
                          <h6 class="mb-0"><%= user.display_name %></h6>
                          <small class="text-muted">
                            가입 <%= user.days_since_signup %>일째
                          </small>
                        </div>
                      </div>
                    </td>
                    
                    <td>
                      <small><%= user.email %></small>
                    </td>
                    
                    <td>
                      <span id="role-badge-<%= user.id %>">
                        <% if user.admin? %>
                          <span class="badge bg-danger">
                            <i class="fas fa-crown me-1"></i>관리자
                          </span>
                        <% else %>
                          <span class="badge bg-secondary">
                            <i class="fas fa-user me-1"></i>일반사용자
                          </span>
                        <% end %>
                      </span>
                    </td>
                    
                    <td>
                      <span id="status-badge-<%= user.id %>">
                        <% case user.status %>
                        <% when 'active' %>
                          <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>활성
                          </span>
                        <% when 'inactive' %>
                          <span class="badge bg-warning">
                            <i class="fas fa-pause-circle me-1"></i>비활성
                          </span>
                        <% when 'suspended' %>
                          <span class="badge bg-danger">
                            <i class="fas fa-ban me-1"></i>정지
                          </span>
                        <% end %>
                      </span>
                    </td>
                    
                    <td>
                      <small class="text-muted">
                        <%= user.created_at.strftime("%Y-%m-%d %H:%M") %>
                      </small>
                    </td>
                    
                    <td>
                      <% if user.last_login_at %>
                        <small class="text-muted">
                          <%= user.last_login_at.strftime("%Y-%m-%d %H:%M") %>
                          <% if user.recently_logged_in? %>
                            <span class="badge bg-success badge-sm ms-1">최근</span>
                          <% end %>
                        </small>
                      <% else %>
                        <small class="text-muted">로그인 기록 없음</small>
                      <% end %>
                    </td>
                    
                    <td>
                      <div class="btn-group" role="group">
                        <%= link_to admin_user_path(user), class: "btn btn-sm btn-outline-primary", title: "상세보기" do %>
                          <i class="fas fa-eye"></i>
                        <% end %>
                        
                        <% unless user == current_user %>
                          <button class="btn btn-sm btn-outline-warning" 
                                  onclick="toggleRole(<%= user.id %>)"
                                  title="권한 변경">
                            <i class="fas fa-exchange-alt"></i>
                          </button>
                          
                          <button class="btn btn-sm btn-outline-info" 
                                  onclick="toggleStatus(<%= user.id %>)"
                                  title="상태 변경">
                            <i class="fas fa-toggle-on"></i>
                          </button>
                          
                          <% if user.status != 'suspended' %>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="suspendUser(<%= user.id %>)"
                                    title="계정 정지">
                              <i class="fas fa-ban"></i>
                            </button>
                          <% end %>
                        <% else %>
                          <span class="badge bg-info">본인</span>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- 페이지네이션 (Kaminari가 있는 경우) -->
        <% if @users.respond_to?(:current_page) %>
          <div class="card-footer bg-white border-0">
            <%= paginate @users, theme: 'bootstrap' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for AJAX actions -->
<script>
function toggleRole(userId) {
  if (!confirm('정말로 이 사용자의 권한을 변경하시겠습니까?')) return;
  
  fetch(`/admin/users/${userId}/toggle_role`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 배지 업데이트
      const badge = document.querySelector(`#role-badge-${userId} span`);
      if (data.new_role === 'admin') {
        badge.className = 'badge bg-danger';
        badge.innerHTML = '<i class="fas fa-crown me-1"></i>관리자';
      } else {
        badge.className = 'badge bg-secondary';
        badge.innerHTML = '<i class="fas fa-user me-1"></i>일반사용자';
      }
      
      // 성공 알림
      showAlert(data.message, 'success');
    } else {
      showAlert(data.error, 'danger');
    }
  })
  .catch(error => {
    showAlert('오류가 발생했습니다.', 'danger');
  });
}

function toggleStatus(userId) {
  if (!confirm('정말로 이 사용자의 계정 상태를 변경하시겠습니까?')) return;
  
  fetch(`/admin/users/${userId}/toggle_status`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 배지 업데이트
      const badge = document.querySelector(`#status-badge-${userId} span`);
      switch(data.new_status) {
        case 'active':
          badge.className = 'badge bg-success';
          badge.innerHTML = '<i class="fas fa-check-circle me-1"></i>활성';
          break;
        case 'inactive':
          badge.className = 'badge bg-warning';
          badge.innerHTML = '<i class="fas fa-pause-circle me-1"></i>비활성';
          break;
        case 'suspended':
          badge.className = 'badge bg-danger';
          badge.innerHTML = '<i class="fas fa-ban me-1"></i>정지';
          break;
      }
      
      showAlert(data.message, 'success');
    } else {
      showAlert(data.error, 'danger');
    }
  })
  .catch(error => {
    showAlert('오류가 발생했습니다.', 'danger');
  });
}

function suspendUser(userId) {
  if (!confirm('정말로 이 사용자의 계정을 정지하시겠습니까?')) return;
  
  fetch(`/admin/users/${userId}/suspend`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 배지 업데이트
      const badge = document.querySelector(`#status-badge-${userId} span`);
      badge.className = 'badge bg-danger';
      badge.innerHTML = '<i class="fas fa-ban me-1"></i>정지';
      
      showAlert(data.message, 'warning');
      
      // 페이지 새로고침 (버튼 상태 업데이트를 위해)
      setTimeout(() => location.reload(), 1500);
    } else {
      showAlert(data.error, 'danger');
    }
  })
  .catch(error => {
    showAlert('오류가 발생했습니다.', 'danger');
  });
}

function showAlert(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alertDiv.style.top = '20px';
  alertDiv.style.right = '20px';
  alertDiv.style.zIndex = '9999';
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alertDiv);
  
  // 3초 후 자동 제거
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 3000);
}
</script> 